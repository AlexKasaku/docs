<h1 id="how-to-test-an-engagement-plan">How to test an Engagement Plan?</h1>

<hr>

<p>
    Debugging Engagement Plans can be tricky, if you do not know what exactly is happening in which period of time with contact in the Engagement Plan.
    <br>
    This guide should help you to find out, what’s going on and when.
</p>

<p><em>Note: this is a guide for developers, marketers probably don’t need to know all the internal details.</em></p>

<p>So, let’s imagine we have a simple engagement plan:</p>

<p>
    <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/engPlan1.png?raw=true" alt="enter image description here" title="">
</p>

<h2 id="states-conditions-and-items-configuration">States, conditions and items configuration</h2>

<ol>
    <li>
        <p><strong>Initial State</strong></p>

        <p>
            <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/InitialStatePageEventSubscription.png?raw=true" alt="enter image description here" title="">
        </p>

        <p>
            Pay attention to <strong>Page Event Subscription</strong>. When you subscribe to exact goal in that field - in this case, Initial State subscribed for Sample Goal - it means that:
            <br>
        </p>
        <ul>
            <li>when contact is in Initial State state</li>
            <li>and contact  triggers Sample Goal</li>
            <li>then and only then engagement automation processes further. In this example it will run a condition we have attached to Initial State. 
            </li>
        </ul>
        <blockquote>
            <p><strong>NB:</strong> you won’t see the results in Marketing Control Panel immediately. A lot of work in Sitecore 8 is done in the background and inside the contact session. We’ll get to it later in chapter How it works.</p>
        </blockquote>
    </li>
    <br>
    Often developers forget to set this Page Event Subscription and just wait that condition will be executed on itself. But no, it won’t.

    <br>
    <br>

    <li>
        <p><strong>Condition</strong></p>



        <p>In this example it is a custom historical condition, but can be anything else:</p>

        <p>
            <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/Condition1.png?raw=true" alt="enter image description here" title="">
            <br>
    </p></li>
    <li><strong>Goal Triggered state</strong>: doesn’t have any specific settings.
    <br>
        <br>
    </li>
    <li><strong>Home item</strong>: nothing special, except of the link to Page1 item. 
    <br>
        <br>
        <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/home_item.png?raw=true" alt="enter image description here" title="">
        <br>
        <br>
    </li>
    <li><strong>Home/Page1 item</strong>: has Sample Goal assigned.
    <br>
        <br>
        <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/page1_item.png?raw=true" alt="enter image description here" title="">
        <br>
        <br>
    </li>
    <li><strong>Additional buttons</strong> on Sample Layout:
    <br>
        <br>
        <ul>
            <li>One of them identifies contact, by calling


                <pre><code>Tracker.Current.Session.Identify("somename")</code></pre>

                and sets its first name by calling



                <pre><code>var facet = Tracker.Current.Contact.GetFacet&lt;Sitecore.Analytics.Model.Entities.IContactPersonalInfo&gt;("Personal");
        facet.FirstName = "somename";</code></pre>

            </li>
            <li>Second button - enrolls user in the plan’s Initial State by calling


                <pre><code>Tracker.Current.Contact.AutomationStates().EnrollInEngagementPlan(planID, stateId)</code></pre>

            </li>
            <li>Third button - ends the session by calling


                <pre><code>Session.Abandon()</code></pre>
            </li>
        </ul>


    </li>
    <li>Everything is deployed, published or live mode (master database) is used.</li>

</ol>

<h2 id="how-it-works">How it works</h2>

<p>Have next things opened for successful debugging and understanding the dataflow:</p>

<ul>
    <li>Sitecore Marketing Control Panel
    <br>
    </li>
    <li><a href="http://robomongo.org/">Robomongo</a>
    </li>
</ul>

<p>Steps during debugging, explained:</p>

<ol>
    <li>Open the Anonymous browser session:
        <br>
        <br>
        <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks1.png?raw=true" alt="enter image description here" title=""><br>
        <br>
    </li>
    <li>Identify your user. This step actually can be omitted, but it is recommended if you do not want to see only IDs in Marketing Control Panel and compare numbers and letters. After you have called Identify, you’ll have a new contact in db.Contacts in Analytics database. You can check how it looks in Robomongo by calling:
<br><br>



    <p><code>db.Contacts.find().skip(390)</code><br></p>


        Skip as many contacts as you have except the last one. <br>
    <br>
        <blockquote>
            <strong>NB:</strong> Actually, your contact is not certainly will be the last conact in the database, because of random mongo data access, but usually it is.
        </blockquote>
        <br>
        This is what you should see there:<br>
    <br>
        <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks2.png?raw=true" alt="enter image description here" title="">
        <br><br>
        Note, that despite we have assigned FirstName to the contact, we don’t see it in database. This is because we assign FirstName after calling Identify. Identify calls FlushContactToXdb method that flushes the data we had by that moment. Rest of the changes will be saved in session and flushed when it ends.


   <br><br><blockquote>
        <strong>NB:</strong>  never call FlushContactToXdb method yourself. It may cause instability of data.</blockquote><br>


    </li>
    <li>
        <p>
            Enroll contact in engagement plan. You won’t see any changes anywhere after you enrolled that contact, because this change exists only in session and is not yet flushed anywhere.
            <br>
            Just to ensure, you may check db.Contacts, db.AutomationStates and db.Interactions collections in Analytics database, nothing will be changed for them.
        </p>
    </li>
    <li>
        <p>
            End the session. 
            <br>
            </p><ul>
                <li>
            Now check your db.AutomationStates. You should see there a document like next:
        </li></ul><p></p>



        <p>
            <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks3.png?raw=true" alt="enter image description here" title=""></p>

        <p>
            Note that this document has StateTransition field, where StateIdBefore is nullID, and StateIdAfter is an id of our Initial State.
    <br>
            This document with StateTransition is created by
    <br>
            <code>AutomationStateManager.SaveChanges</code> method, which is called by <code>SaveAutomationRecords</code> processor from <code>&lt;submitContact&gt;</code> pipeline. <code>&lt;submitContact&gt;</code> pipeline is called from <code>FlushContactToXdb</code>, that happens again on the session end.
        </p>

        <blockquote>
            <p><strong>NB:</strong>  never call AutomationStateManager.SaveChanges method yourself. It may cause instability of data.</p>
        </blockquote>
        <p>Now you should <strong>wait</strong> until this document looses its StateTransition field and becomes something like that:</p>

        <p>
            <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks5.png?raw=true" alt="enter image description here" title=""></p>

        <p>It means, that engagement automation has already processed StateTransition and moved contact to the Initial State. <strong>/this needs to be checked, as I’m not sure if this is done by automation worker or aggregation part/</strong></p>

        <p>
    </p></li>
    <li>Now check Marketing Control Panel, plan’s Initial State. There should be our KateButenko contact:<br><br>

        <p>
            <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks8.png?raw=true" alt="enter image description here" title="">
            <br>
    </p></li>
    <li>Now check your db.Interactions. It should have one additional interaction.<br><br>
<img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks6.png?raw=true" alt="enter image description here" title="">

        <p><br>Note the query I use for checking latest interactions, you can use it too:</p>

        <code>db.Interactions.find({StartDateTime: { $gte : new ISODate("2015-03-13T14:00:31Z")}})</code>

        <p>
    </p></li>
    <li>Now check your db.Contacts. The contact that we saw after step 2 (identifying) now gets additional fields:<br><br>

        <p>
            <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks7.png?raw=true" alt="enter image description here" title=""></p>

    </li>
    
    <li>Now let’s return to browser page and go to Page1, which as we remember has Sample Goal assigned and should move our contact through the Engagement Plan.<br>
        <br>
    </li>
    <li>End session again, for our data to get to xDB.<br>
        <br>
        <ul>
            <li>Now check your db.AutomationStates. You should see there an old document, processed, and a new document like next:<br><br>


                <p>
                    <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks11.png?raw=true" alt="enter image description here" title=""></p>

                <p>
                    The new document should contain StateTransition with transferring from Initial State to Goal Triggered state.
    <br>
                    Now you should <strong>wait</strong> until this document looses its StateTransition field and merges together with previous document:
                </p>

                <p>
                    <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks12.png?raw=true" alt="enter image description here" title=""></p>

                <p>It means, that engagement automation has already processed StateTransition and moved contact from Initial State to Goal Triggered state. <strong>/this needs to be checked, as I’m not sure if this is done by automation worker or aggregation part/</strong></p>

                <p>
            </p></li>
            <li>Now check Marketing Control Panel, plan’s Goal Triggered state. There should be our KateButenko contact:<br><br>

                <p>
                    <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks13.png?raw=true" alt="enter image description here" title=""></p>

                <p>
            </p></li>
            <li>You can also check db.Interactions collection to reassure that your second interaction has appeared there:

                <p>
                    <img src="http://sitecore-community.github.io/docs/images/Engagement%20Automation/Testing%20Plan/howitworks10.png?raw=true" alt="enter image description here" title=""></p>
            </li>
        </ul>
    </li>
</ol>